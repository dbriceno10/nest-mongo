CONFIGURACIN POR AMBIENTES

Una aplicaci贸n profesional suele tener m谩s de un ambiente. Ambiente local, ambiente de desarrollo, ambiente de pruebas, producci贸n, entre otros, dependiendo la necesidad del equipo y de la organizaci贸n. Veamos c贸mo puedes administrar N cantidad de ambientes en NestJS.

Configuraci贸n din谩mica del entorno
Configuremos la aplicaci贸n para intercambiar f谩cilmente entre diversos ambientes, cada uno con su propia configuraci贸n.

1. Archivo principal para manejo de ambientes
Crea un archivo llamado enviroments.ts (o el nombre que prefieras) que contendr谩 un objeto con una propiedad por cada ambiente que tenga tu aplicaci贸n.

// src/enviroments.ts
export const enviroments = {
  dev: '.env',
  test: '.test.env',
  prod: '.prod.env',
};
2. Configuraci贸n por ambiente
Crea un archivo .env por cada ambiente que necesites. Recuerda que todos los archivos finalizados en .env no deben guardarse en GIT.

// .test.env
DATABASE_NAME=my_db_test
API_KEY=12345
// .prod.env
DATABASE_NAME=my_db_prod
API_KEY=67890
3. Importando variables de entorno
Importa en el m贸dulo principal de tu aplicaci贸n el archivo principal para manejo de ambientes y, a trav茅s de una 煤nica variable de entorno llamada NODE_ENV, elegir谩s qu茅 configuraci贸n usar.

NODE_ENV es una variable de entorno propia de NodeJS y del framework Express que se encuentra preseteada en tu aplicaci贸n.

import { enviroments } from './enviroments'; // 

@Module({
  imports: [
    ConfigModule.forRoot({
      envFilePath: enviroments[process.env.NODE_ENV] || '.env', // 
      isGlobal: true,
    }),
  ],
})
export class AppModule {}
4. Inicio de la aplicaci贸n
Finalmente, para iniciar tu aplicaci贸n basta con el comando NODE_ENV=test npm run start:dev o NODE_ENV=prod npm run start:dev para configurar la variable de entorno principal NODE_ENV y escoger qu茅 configuraci贸n utilizar.

5. Utilizando las variables de entorno
Puedes utilizar las variables de entorno en tu aplicaci贸n de dos maneras. Con el objeto global de NodeJS llamado process:

process.env.DATABASE_NAME
process.env.API_KEY
O puedes usar estas variables a trav茅s del servicio ConfigService proveniente de @nestjs/config.

import { ConfigService } from '@nestjs/config';

@Injectable()
export class AppService {

  constructor(private config: ConfigService) {}

  getEnvs(): string {
    const apiKey = this.config.get<string>('API_KEY');
    const name = this.config.get('DATABASE_NAME');
    return `Envs: ${apiKey} ${name}`;
  }
}
De este modo, configura de la mejor manera que necesites para tu aplicaci贸n el manejo de m煤ltiples ambientes, cada uno con su propia configuraci贸n.

Cuadro de c贸digo para la configuraci贸n de ambientes
// .stag.env
DATABASE_NAME=my_db_stag
API_KEY=333
// .prod.env
DATABASE_NAME=my_db_prod
API_KEY=999
// src/enviroments.ts
export const enviroments = {
  dev: '.env',
  stag: '.stag.env',
  prod: '.prod.env',
};
// src/app.module.ts
...

import { enviroments } from './enviroments'; // 

@Module({
  imports: [
    ConfigModule.forRoot({
      envFilePath: enviroments[process.env.NODE_ENV] || '.env', // 
      isGlobal: true,
    }),
    ...
  ],
  ...
})
export class AppModule {}
// src/app.service.ts
import { ConfigService } from '@nestjs/config'; // 

@Injectable()
export class AppService {
  constructor(
    @Inject('TASKS') private tasks: any[],
    private config: ConfigService,  // 
  ) {}
  getHello(): string {
    const apiKey = this.config.get<string>('API_KEY');  // 
    const name = this.config.get('DATABASE_NAME');  // 
    return `Hello World! ${apiKey} ${name}`;
  }
}
Rin with NODE_ENV // 
NODE_ENV=prod npm run start:dev
NODE_ENV=stag npm run start:dev

Contribuci贸n creada por: Kevin Fiorentino.
