Conectando Mongo a los servicios

Establecida la conexi贸n a la base de datos con Mongoose y creadas las entidades que mapean la informaci贸n, es momento de realizar las consultas a la base de datos desde los servicios.

Ejecutando consultas con Mongoose
Aqu铆 tienes una serie de pasos que te ayudar谩n durante este proceso.

Paso 1: importaci贸n del esquema en los servicios
Comienza inyectando el esquema creado en el servicio que ser谩 el responsable de realizar las consultas.

// modules/products/products.service.ts
import { InjectModel } from '@nestjs/mongoose';
import { Model } from 'mongoose';

@Injectable()
export class ProductsService {

  constructor(@InjectModel(Product.name) private productModel: Model<Product>) {}

  findAll() {
    return this.productModel.find().exec();
  }

  findOne(id: string) {
    return this.productModel.findById(id).exec();
  }
}
Utilizando InjectModel, inyectas el esquema de productos en el servicio de productos.

Paso 2: importaci贸n del servicio en los controladores
Los servicios son los responsables de realizar las consultas a la base de datos, pero los controladores son quienes determinan cu谩ndo hay que realizar esas consultas.

// module/products/products.controller.ts
@Controller('products')
export class ProductsController {

  @Get()
  async getAll() {
    return await this.productsService.findAll();
  }

  @Get(':productId')
  async getOne(@Param('productId') productId: string) {
    return await this.productsService.findOne(productId);
  }
}
Crea tantos endpoints como necesites para responder a la necesidad de obtenci贸n de los datos a trav茅s de GET.
As铆, ya tienes completada tu conexi贸n a la base de datos y obtenci贸n de datos en tu API a trav茅s de Mongoose y sus esquemas.

Contribuci贸n creada por: Kevin Fiorentino (Platzi Contributor).

C贸digo de ejemplo para conectar Mongo a los servicios
// src/products/services/products.service.ts

import { InjectModel } from '@nestjs/mongoose';
import { Model } from 'mongoose';

...

@Injectable()
export class ProductsService {
  constructor(
    @InjectModel(Product.name) private productModel: Model<Product>, // 
  ) {}
  ...

  findAll() { // 
    return this.productModel.find().exec();
  }

  async findOne(id: string) {  // 
    const product = await this.productModel.findById(id).exec();
    if (!product) {
      throw new NotFoundException(`Product #${id} not found`);
    }
    return product;
  }
  ...

}
// src/products/controllers/products.controller.ts

@Controller('products')
export class ProductsController {
   ...

  @Get(':productId')
  getOne(@Param('productId') productId: string) {   // 
    return this.productsService.findOne(productId);
  }
}
// src/users/services/users.service.ts
@Injectable()
export class UsersService {
  ...

  async getOrderByUser(id: number) {   // 
    const user = this.findOne(id);
    return {
      date: new Date(),
      user,
      products: await this.productsService.findAll(),   //  implement await
    };
  }
}
